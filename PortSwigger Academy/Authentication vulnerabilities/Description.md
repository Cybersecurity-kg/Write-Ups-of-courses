# Write‑up: Authentication Vulnerabilities (Web Security Academy)

**Автор:**  
**Курс:** PortSwigger Web Security Academy — Authentication vulnerabilities  
**Дата:** 25.07.2025

---

## Содержание

1. [Username Enumeration](#1-username-enumeration)  
2. [Brute-force (классический)](#2-brute-force-классический)  
3. [Broken Brute-force Protection](#3-broken-brute-force-protection)  
4. [Weak Account Lockout / DoS на аккаунт](#4-weak-account-lockout--dos-на-аккаунт)  
5. [Password Reset Poisoning](#5-password-reset-poisoning)  
6. [Password Reset Logic Flaws](#6-password-reset-logic-flaws)  
7. [Password Change Logic Flaws](#7-password-change-logic-flaws)  
8. [Stay-logged-in / Remember-me Cookies](#8-stay-logged-in--remember-me-cookies)  
9. [Session Fixation](#9-session-fixation)  
10. [2FA / MFA Bypass](#10-2fa--mfa-bypass)  
11. [Multi-step Login Logic Flaws](#11-multi-step-login-logic-flaws)  
12. [OAuth / SSO Misconfigurations (в контексте аутентификации)](#12-oauth--sso-misconfigurations-в-контексте-аутентификации)  
13. [Чеклисты: тестирование и защита](#13-чеклисты-тестирование-и-защита)  
14. [Инструменты и приёмы в Burp Suite](#14-инструменты-и-приёмы-в-burp-suite)

---

## 1) Username Enumeration

**Определение**  
Различимое поведение приложения позволяет определять существующие логины.

**Признаки**
- Разные тексты ошибок: «Пользователь не найден» vs «Неверный пароль».
- Разные HTTP-коды / размеры ответа / TTL ответа.
- Восстановление пароля выдаёт «если пользователь существует…» только для валидных логинов.

**Эксплуатация**
- Словарь логинов → Intruder (Pitchfork/Cluster Bomb) → сравнение `len`, `status`, `time`.
- Time-based side-channel (усреднение времени ответа).

**Защита**
- Унифицированные сообщения об ошибке.
- Константное время обработки.
- Rate limiting + мониторинг аномалий.

---

## 2) Brute-force (классический)

**Определение**  
Полный перебор пароля для известного логина или набора логинов.

**Техники**
- Пароли из утечек, топ‑N списки.
- Перебор через `/login`, `/authenticate`, `/oauth/token`.

**Эксплуатация**
- Intruder: Single target, список паролей.
- Turbo Intruder: высокоскоростной перебор.
- Распараллеливание по нескольким логинам.

**Защита**
- Lockout / progressive delay.
- 2FA.
- Strong password policy.
- IP/user fingerprint rate limit.

---

## 3) Broken Brute-force Protection

**Определение**  
Обход внедрённой защиты перебора.

**Техники обхода**
- Ротация IP (proxy / X-Forwarded-For).
- Распараллеливание по множеству логинов (lockout привязан к одному).
- Разные эндпойнты (mobile/legacy API) без rate limit.
- Обход по “password reset” эндпойнту.
- Перебор второго фактора отдельно (см. 2FA Bypass).

**Защита**
- Поведенческая корреляция (IP + user + device + UA).
- Сквозной rate limit по всей auth-поверхности.
- Централизованный enforcement.

---

## 4) Weak Account Lockout / DoS на аккаунт

**Определение**  
Слабая блокировка позволяет либо обойти лимиты, либо устроить DoS на конкретного пользователя.

**Векторы**
- Блокировка только по логину → злоумышленник блокирует жертву.
- Отсутствие логирования IP/UA → обход лимита.

**Защита**
- Комбинированная метрика: user + IP + device fingerprint.
- Капча, прогрессивные задержки.
- Детект массовых блокировок.

---

## 5) Password Reset Poisoning

**Определение**  
Подмена хоста/протокола при генерации ссылки сброса (Host / X-Forwarded-Host / X-Forwarded-Proto).

**Эксплуатация**
1. Отправка запроса на сброс с подменённым заголовком `Host: attacker.com`.
2. Жертве уходит письмо со ссылкой на домен атакующего.
3. Жертва переходит, токен уходит злоумышленнику.

**Защита**
- Жёстко заданный доверенный базовый URL на сервере.
- Игнорирование небезопасных заголовков.
- Валидация домена перед отправкой.

---

## 6) Password Reset Logic Flaws

**Определение**  
Ошибки в логике сброса пароля: предсказуемые токены, токен не инвалидируется, токен привязан не к тому юзеру, токен в Referer.

**Эксплуатация**
- Утечка токена через Referer третьим доменам.
- Многократное использование токена.
- Не привязали токен к аккаунту → можно сбросить пароль другого пользователя.

**Защита**
- Криптографически сильные одноразовые токены, короткий TTL.
- Привязка токена к user + действующей сессии сброса.
- Инвалидация токена после первого использования.

---

## 7) Password Change Logic Flaws

**Определение**  
Ошибки при смене пароля уже аутентифицированным пользователем.

**Типичные баги**
- Нет проверки текущего пароля.
- Параметр `username` или `id` контролируется клиентом и не перепроверяется на сервере.
- Нет повторной аутентификации для критических операций.

**Эксплуатация**
- Меняем пароль другому пользователю, подставив его `id`.
- Смена пароля без знания старого.

**Защита**
- Обязательная проверка текущего пароля.
- Игнорирование клиентского `username/id`, берём из сессии.
- Повторная аутентификация/2FA на чувствительных операциях.

---

## 8) Stay-logged-in / Remember-me Cookies

**Определение**  
Долгоживущие токены в cookie, слабо защищённые (base64(user:pass), слабая подпись, без привязки к устройству).

**Эксплуатация**
- Кража cookie → мгновенный доступ.
- Расшифровка/подбор слабых токенов.
- Reuse токена между пользователями (отсутствие device binding).

**Защита**
- HMAC-подписанные, непредсказуемые, короткоживущие токены.
- Привязка к устройству/IP.
- Инвалидация при logout и смене пароля.

---

## 9) Session Fixation

**Определение**  
Навязывание жертве заранее известного session ID, который затем авторизуется.

**Эксплуатация**
- Заставить жертву перейти по ссылке с `JSESSIONID=known`.
- После логина сессия не регенерируется → злоумышленник использует тот же ID.

**Защита**
- Перегенерация session ID после логина/privilege escalation.
- HttpOnly, Secure, SameSite для cookies.
- Запрет передачи session id в URL.

---

## 10) 2FA / MFA Bypass

**Определение**  
Обход второго фактора из-за ошибок в логике или повторного использования сессии.

**Техники**
- Доступ к функционалу, не требующему подтверждения 2FA (скрытые эндпойнты).
- Повторное использование pre-2FA сессии.
- Перебор OTP без rate limit.
- Одноступенчатый сброс пароля, который убирает 2FA.

**Защита**
- Маркер состояния 2FA в сессии, проверка на каждом защищённом эндпойнте.
- Rate limit/lockout на OTP.
- Инвалидация всех pre-auth сессий после прохождения 2FA.
- Принудительная 2FA при изменении критических настроек.

---

## 11) Multi-step Login Logic Flaws

**Определение**  
Ошибки распределённой по шагам аутентификации (шаг ввода логина → шаг ввода пароля → 2FA → подтверждение email).

**Векторы**
- Несогласованность состояний между шагами.
- Пропуск отдельных шагов прямыми запросами.
- Использование параметров из клиента вместо server-side session state.

**Защита**
- Жёсткая state-машина на сервере.
- Проверка корректного перехода между шагами.
- Инвалидация промежуточных токенов.

---

## 12) OAuth / SSO Misconfigurations (в контексте аутентификации)

**Определение**  
Ошибки в OAuth/OpenID Connect, влияющие на аутентификацию: неправильная валидация redirect_uri, state, nonce, aud/iss, алгоритма подписи.

**Типовые уязвимости**
- Open redirect на `redirect_uri` → кража кода/токена.
- `state` отсутствует или предсказуем → CSRF/forced login.
- Подмена алгоритма `none` / слабый JWKS кеш.
- ID Token не верифицируется (iss, aud, nonce).

**Защита**
- Жёсткий whitelist redirect_uri.
- Обязательный проверенный `state` и `nonce`.
- Корректная валидация подписи и всех claim.
- PKCE для public-клиентов.

---

## 13) Чеклисты: тестирование и защита

### Тестирование (пентестер)

- [ ] Единые ли сообщения об ошибке входа.  
- [ ] Тайминги на валидный/невалидный логин.  
- [ ] Лимиты на количество попыток (по user/IP/fingerprint).  
- [ ] Возможность DoS через lockout.  
- [ ] Прямые запросы, обходящие шаги логина/2FA.  
- [ ] Повторное использование pre-auth сессий.  
- [ ] Поведение password reset: токены, заголовки Host/XFH, TTL, одноразовость.  
- [ ] Возможность смены пароля без старого/для чужого пользователя.  
- [ ] Session fixation: регенерация ID после логина.  
- [ ] Remember-me: формат, подпись, срок, привязка к устройству.  
- [ ] OAuth: redirect_uri, state, nonce, подпись ID Token.

### Защита (инженер)

- [ ] Централизованный auth-сервис, единые политики.  
- [ ] Сквозной rate limit и поведенческая корреляция.  
- [ ] Полная регенерация сессий на ключевых переходах.  
- [ ] Короткоживущие одноразовые токены, строгая проверка всех claim.  
- [ ] Логирование и алерты на аномалии (массовые попытки, lockout-атаки, 2FA OTP перебор).  
- [ ] Регулярные ручные ревью auth-флоу.

---

## 14) Инструменты и приёмы в Burp Suite

**Intruder профили**
- **Sniper**: один параметр (пароль).  
- **Pitchfork**: параллельный перебор логин/пароль.  
- **Cluster Bomb**: декартово произведение логинов и паролей.  

**Turbo Intruder**
- Высокоскоростной перебор, полезен для time-based side-channel и обхода rate limit.

**Comparer**
- Быстрое сравнение различий ответов при username enumeration.

**Repeater**
- Пошаговое исследование логики 2FA, password reset, password change.

**Logger++ / Flow / Audit logs**
- Анализ таймингов, статусов, размеров тела ответа.

---

